###################################################################################

This is a set of benchmarks for using PENCIL in the image processing problem domain

###################################################################################

## Building ##

To build the CARP-Benchmarks, you need:
- A working OpenCL driver.
- The following packages needs to be installed (at least on Ubuntu 13.10):
	libboost-filesystem-dev libboost-serialization-dev libboost-system-dev (or, full Boost: libboost-all-dev)
	libtbb-dev
	build-essential
	p7zip
	cmake
- PPCG compiler
        Refer to PPCG readme how to build and install.
        Requires a version that also installs the PENCIL runtime.
- An OpenCV build:
	Tested with 2.4.9.1
	Download OpenCV
	    git clone https://github.com/Itseez/opencv.git
	Checkout 2.4.9.1 or newer:
	    cd opencv
	    git checkout 2.4.9.1
	    cd ..
	Configure build with CMake:
	    mkdir opencv-build
	    cd opencv-build
	    cmake ../opencv -DWITH_TBB=ON -DENABLE_AVX=ON -DENABLE_SSE41=ON -DENABLE_SSE42=ON  -DENABLE_SSSE3=ON -DENABLE_SSE3=ON
	  (Warning, if your CPU or OS does not support AVX/SSEx instruction sets, do not add the corresponding compile switches)
	    make all -j12
	Make sure the necessary modules are to be built - CMake should print a (long) status with a "To be built:" list, it should contain core, ocl and highgui (plus their dependencies)
	Optionally, install it as a system library:
	    sudo make install
	
	Alternatively, you can try newer versions that might have fixed the issue in the patch, but those versions are not tested.
- Compile benchmark:
        Crate a directory for out-of-source build, run cmake and make:
        -> OPENCL_LIBRARY is a required parameter (For ARM Mali, add libOpenCL.so and libmali.so).
        -> Based on your OpenCL device, it is recommended to set up PENCIL_FLAGS:
            PENCIL_FLAGS_1D_BLOCKSIZE and PENCIL_FLAGS_2D_BLOCKSIZE should be set to the maximum workgroup sizes (for 1D and 2D kernels). For instance, AMD Radeon cards should use 256 and 16,16
            PENCIL_FLAGS_LOCAL_MEMORY_SIZE is the amount of used __local memory (set to "Max local memory:" reported by clinfo). Alternatively set to 0 to disable __local memory (For instance, ARM Mali)
        -> Optionally, as performance tuning try turning PENCIL_FLAGS_MAXFUSE, PENCIL_FLAGS_NO_SEPARATE_COMP, PENCIL_FLAGS_DISABLE_PRIVATE flags ON or OFF.
        -> CMake can be configured from a GUI windows using cmake-gui (it lists all known parameters).
        -> If something is not installed at the standard paths (/usr, /usr/local), then run cmake-gui and edit the variables (should be straight-forward)

            mkdir pencil-benchmarks-imageproc-build
            cd pencil-benchmarks-imageproc-build
            cmake -DCMAKE_BUILD_TYPE=Release -DOPENCL_LIBRARY=/path/to/libOpenCL.so -DPENCIL_FLAGS_1D_BLOCKSIZE=A -DPENCIL_FLAGS_1D_BLOCKSIZE="B,C" -DPENCIL_FLAGS_LOCAL_MEMORY_SIZE=D path/to/pencil-benchmarks-imageproc-repo
            make all -j12
- Build benchmark:
	cd repository_root_path
	make all -j12
	
## Tested hardware parameters ##
AMD Radeon R9 290
  -DPENCIL_FLAGS_1D_BLOCKSIZE=256 -DPENCIL_FLAGS_1D_BLOCKSIZE="16,16" -DPENCIL_FLAGS_LOCAL_MEMORY_SIZE=32768 -DPENCIL_FLAGS_MAXFUSE=OFF -DPENCIL_FLAGS_NO_SEPARATE_COMP=OFF -DPENCIL_FLAGS_DISABLE_PRIVATE=OFF

Intel HD Graphics 4000
  -DPENCIL_FLAGS_1D_BLOCKSIZE=512 -DPENCIL_FLAGS_1D_BLOCKSIZE="32,16" -DPENCIL_FLAGS_LOCAL_MEMORY_SIZE=??? -DPENCIL_FLAGS_MAXFUSE=??? -DPENCIL_FLAGS_NO_SEPARATE_COMP=??? -DPENCIL_FLAGS_DISABLE_PRIVATE=???

ARM Mali T628
  -DPENCIL_FLAGS_1D_BLOCKSIZE=64 -DPENCIL_FLAGS_1D_BLOCKSIZE="8,8" -DPENCIL_FLAGS_LOCAL_MEMORY_SIZE=0 -DPENCIL_FLAGS_MAXFUSE=??? -DPENCIL_FLAGS_NO_SEPARATE_COMP=??? -DPENCIL_FLAGS_DISABLE_PRIVATE=???

Please, share the parameters to your device here
  
## Running ##

- Change to the build directory.
- Run test_*
	Each executable runs a different operator with all three (C++, OpenCL, PENCIL) implementations.
	Results are cross-checked, and if there is no difference (within a small allowed precision error), total times are reported at the end.
